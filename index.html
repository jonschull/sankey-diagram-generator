<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Diagram Generator</title>
    <!-- jQuery UI for draggable functionality -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Mermaid for the Sankey diagram -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .active-button {
            background-color: #e74c3c;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .panel {
            flex: 1;
            padding: 20px;
            overflow: auto;
            box-sizing: border-box;
        }
        .left-panel {
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .right-panel {
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        #sankey-options {
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .option-group {
            margin-bottom: 10px;
        }
        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        .option-group select, 
        .option-group input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .option-group input[type="number"] {
            width: 80px;
        }
        .option-group input[type="color"] {
            width: 40px;
            height: 30px;
            padding: 0;
            cursor: pointer;
        }
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #mermaid-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 500px;
        }
        .mermaid {
            width: 100%;
            max-width: 100%;
            min-height: 500px;
        }
        .mermaid-wrapper {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        .table-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #editable-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        #editable-table th, #editable-table td {
            border: 1px solid #ddd;
            padding: 8px;
            position: relative;
        }
        #editable-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            text-align: left;
            position: relative;
            padding-top: 30px; /* Make room for the column controls */
        }
        #editable-table tr {
            cursor: move;
        }
        #editable-table tr.selected {
            background-color: #e3f2fd !important;
        }
        #editable-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #editable-table tr:hover {
            background-color: #f1f1f1;
        }
        .editable {
            min-width: 100px;
            min-height: 20px;
        }
        .editable a {
            color: #0066cc;
            text-decoration: underline;
            cursor: pointer;
        }
        .editable a:hover {
            text-decoration: none;
        }
        .column-controls {
            display: none; /* Hide the separate column controls section */
        }
        /* Column control buttons inside table headers */
        .header-controls {
            position: absolute;
            top: 2px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
        }
        .header-button {
            background-color: #f2f2f2;
            border: 1px solid #ddd;
            padding: 2px 5px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-button:hover {
            background-color: #e0e0e0;
        }
        .header-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
        }
        .modal-content input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        .info-panel {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            padding: 10px;
            margin-bottom: 15px;
        }
        .file-input {
            display: none;
        }
        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .panel {
                flex: none;
                height: 50vh;
            }
            .left-panel {
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
        }
        .warning-cell {
            background-color: #fff3cd !important;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #mermaid-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .error-message {
            margin-bottom: 10px;
        }
        .error-details {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sankey Diagram Generator</h1>
        <div class="header-buttons">
            <button id="export-data" class="button">Export Mermaid</button>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Left Panel - Editable Table -->
        <div class="panel left-panel">
            <div class="info-panel">
                <p>Enter your data in the format: Country, City/Town, Person, Project, Organization. Each row will be processed to create Sankey diagram connections.</p>
                <p><strong>Tips:</strong> Use the arrow buttons in the column headers to move columns left or right. Drag rows to reorder them. Click cells to edit content.</p>
                <p><strong>Links:</strong> Add links using the format [text](url) - for example: [Google](https://google.com)</p>
                <p><strong>Diagram Options:</strong> Adjust the Sankey diagram appearance using the controls in the right panel. Changes update in real-time.</p>
                <p><strong>Buttons:</strong> 
                   "Export Mermaid" saves the diagram code as a standard Mermaid file, 
                   "Save CSV" exports your table data as a CSV file.
                </p>
            </div>
            <div class="table-controls">
                <button id="add-row" class="button">Add Row</button>
                <button id="delete-row" class="button">Delete Row</button>
                <button id="rename-column" class="button">Rename Column</button>
                <button id="clear-table" class="button">Clear Table</button>
                <button id="load-sample" class="button">Load Sample Data</button>
                <button id="load-csv-btn" class="button">Load CSV</button>
                <button id="export-csv" class="button">Save CSV</button>
                <input type="file" id="csv-file-input" class="file-input" accept=".csv">
            </div>
            
            <div class="url-input-container" style="margin: 10px 0; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="csv-url-input" placeholder="Enter CSV URL" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vSiwAywSDNHWbSj-vlGMwZ1kzUzzUw9TYpZCZyya9J08UutLzNBFsvfCcL3qDMbSCQUWsMRXq6nXyjD/pub?gid=1670226245&single=true&output=csv">
                <button id="load-csv-url" class="button">Load from URL</button>
            </div>
            
            <div id="table-container">
                <table id="editable-table">
                    <thead>
                        <tr id="header-row">
                            <th data-name="Country">
                                <div class="header-controls">
                                    <button class="header-button move-left" data-index="0" disabled>&larr;</button>
                                    <button class="header-button move-right" data-index="0">&rarr;</button>
                                </div>
                                Country
                            </th>
                            <th data-name="City/Town">
                                <div class="header-controls">
                                    <button class="header-button move-left" data-index="1">&larr;</button>
                                    <button class="header-button move-right" data-index="1">&rarr;</button>
                                </div>
                                City/Town
                            </th>
                            <th data-name="Person">
                                <div class="header-controls">
                                    <button class="header-button move-left" data-index="2">&larr;</button>
                                    <button class="header-button move-right" data-index="2">&rarr;</button>
                                </div>
                                Person
                            </th>
                            <th data-name="Project">
                                <div class="header-controls">
                                    <button class="header-button move-left" data-index="3">&larr;</button>
                                    <button class="header-button move-right" data-index="3">&rarr;</button>
                                </div>
                                Project
                            </th>
                            <th data-name="Organization">
                                <div class="header-controls">
                                    <button class="header-button move-left" data-index="4">&larr;</button>
                                    <button class="header-button move-right" data-index="4" disabled>&rarr;</button>
                                </div>
                                Organization
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Right Panel - Sankey Diagram -->
        <div class="panel right-panel">
            <div id="sankey-options">
                <h3>Sankey Diagram Options</h3>
                <div class="options-grid">
                    <div class="option-group">
                        <label for="node-alignment">Node Alignment</label>
                        <select id="node-alignment">
                            <option value="justify" selected>Justify</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="center">Center</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label for="show-values">Show Values</label>
                        <select id="show-values">
                            <option value="false" selected>No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label for="diagram-scale">Diagram Scale (%)</label>
                        <input type="number" id="diagram-scale" min="50" max="200" value="100" step="10">
                    </div>
                    <div class="option-group">
                        <label for="font-size">Font Size (px)</label>
                        <input type="number" id="font-size" min="8" max="24" value="12" step="1">
                    </div>
                </div>
                <div class="info-panel" style="margin-top: 10px; font-size: 0.9em; background-color: #f8f9fa; padding: 8px; border-radius: 4px;">
                    <p><strong>Note:</strong> Mermaid's Sankey implementation has limited options. Only node alignment and value display can be customized.</p>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button id="save-options" class="button">Save Options</button>
                    <button id="load-options" class="button">Load Options</button>
                    <button id="fit-width" class="button" title="Scale diagram to fit available width">Fit to Width</button>
                    <input type="file" id="options-file-input" class="file-input" accept=".json" style="display: none;">
                </div>
            </div>
            <div id="mermaid-container">
                <div id="mermaid-error"></div>
                <div class="mermaid-wrapper"></div>
            </div>
        </div>
    </div>
    
    <!-- Rename Column Modal -->
    <div id="rename-modal" class="modal">
        <div class="modal-content">
            <h3>Rename Column</h3>
            <select id="column-select">
                <option value="0">Country</option>
                <option value="1">City/Town</option>
                <option value="2">Person</option>
                <option value="3">Project</option>
                <option value="4">Organization</option>
            </select>
            <input type="text" id="new-column-name" placeholder="New column name">
            <div class="modal-buttons">
                <button id="cancel-rename" class="button" style="background-color: #f44336;">Cancel</button>
                <button id="confirm-rename" class="button">Rename</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize mermaid with default settings
        let sankeySettings = {
            nodeWidth: 15,
            nodePadding: 10,
            curvature: 0.5,
            nodeAlignment: "justify", // left, right, justify
            showValues: true,
            diagramScale: 100,
            theme: "default",
            fontSize: 12 // Added font size setting with default of 12px
        };
        
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false },
            sankey: { 
                useMaxWidth: true,
                nodeWidth: sankeySettings.nodeWidth,
                nodePadding: sankeySettings.nodePadding,
                curvature: sankeySettings.curvature,
                nodeAlignment: sankeySettings.nodeAlignment,
                showValues: sankeySettings.showValues
            }
        });

        // Sample data from makeMermaid.py
        const sampleData = [
            ["Uganda", "Nakivale", "Marius", "Biochar", "Umoja"],
            ["", "", "", "Biochar", "EcoSystem Regeneration"],
            ["Uganda", "Nakivale", "Kalombo", "RED", "AYISD"],
            ["Uganda", "Nakivale", "Kalombo", "Woodlot", "AYISD"],
            ["Uganda", "Nakivale", "Samuel", "", "AYISD"],
            ["Uganda", "Nakivale", "Marius", "Biogen", "Umoja"],
            ["Uganda", "Nakivale", "Marius", "Permaculture", "Umoja"],
            ["Uganda", "Jinja", "Edward", "Hamlet", "ERA"],
            ["Uganda", "Jinja", "Edward", "Hamlet", "WUN"],
            ["Uganda", "Jinja", "Edward", "Training", "ERA"],
            ["Uganda", "Nakivale", "Ansima", "Training", "Folona"],
            ["Uganda", "Mubende", "Muhange", "MicroLoans", "Fliptown"],
            ["Senegal", "Dakar", "Ousmane", "Training", "REDES"],
            ["Uganda", "Jinja", "Leonce", "Minelands", "Save he Planet"],
            ["DRC", "Bukavu", "Bulonza", "Training", "On Time Aid"],
            ["DRC", "Goma", "Leonce", "Minelands", "Save the Planet"],
            ["DRC", "Goma-Bujumbura", "Climbien", "social projet", "Oursfera Group"],
            ["Nigeria", "Taraba", "Dayo", "Govt", "ICCREA"],
            ["Kenya", "Nairobi", "Leonard", "Comms", "We4Climate"],
            ["Kenya", "Nairobi", "Leonard", "Comms", "ERAa"],
            ["Kenya", "Oyugis", "Moses", "Training", "GFCA"]
        ];

        $(document).ready(function() {
            // Set initial values for Sankey options inputs
            $("#node-width").val(sankeySettings.nodeWidth);
            $("#node-padding").val(sankeySettings.nodePadding);
            $("#curvature").val(sankeySettings.curvature);
            $("#node-alignment").val(sankeySettings.nodeAlignment);
            $("#show-values").val(sankeySettings.showValues);
            $("#diagram-scale").val(sankeySettings.diagramScale);
            $("#font-size").val(sankeySettings.fontSize);
            
            // Load data from AfricaData.csv on page load
            loadCSVFromFile('AfricaData.csv');
            
            // Initialize row sorting
            initTableRowSorting();
            
            // Initialize column controls
            initColumnControls();
            
            // Make cells editable
            $("#editable-table").on("click", "td.editable", function(e) {
                // Don't make cell editable if clicking on a link
                if ($(e.target).is('a')) {
                    return;
                }
                
                // Get the original Markdown content if it exists
                const markdownContent = $(this).attr('data-markdown');
                
                $(this).attr("contenteditable", "true");
                
                // If we have stored Markdown content, restore it for editing
                if (markdownContent) {
                    $(this).text(markdownContent);
                }
                
                $(this).focus();
                
                // Mark the row as selected
                $("#editable-table tbody tr").removeClass("selected");
                $(this).closest("tr").addClass("selected");
            });
            
            // Handle cell blur and update diagram
            $("#editable-table").on("blur", "td.editable", function() {
                $(this).attr("contenteditable", "false");
                
                // Get the current text content (which may contain Markdown links)
                const currentContent = $(this).text().trim();
                
                // Store the Markdown content for future editing
                if (/\[([^\]]+)\]\(([^)]+)\)/g.test(currentContent)) {
                    $(this).attr('data-markdown', currentContent);
                    
                    // Convert Markdown links to HTML links for display
                    let displayContent = currentContent.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                    $(this).html(displayContent);
                } else {
                    // If no Markdown links, just use the text
                    $(this).removeAttr('data-markdown');
                }
                
                // Update the diagram with current settings
                redrawSankeyDiagram();
                
                // Keep the row selected
                $(this).closest("tr").addClass("selected");
            });
            
            // Process links in cell content
            function processLinksInCell(cell) {
                // Store the original content with Markdown links
                const originalContent = cell.text();
                
                // Check if the content contains Markdown links
                const hasMarkdownLinks = /\[([^\]]+)\]\(([^)]+)\)/g.test(originalContent);
                
                if (hasMarkdownLinks) {
                    // Store the Markdown format in a data attribute for editing
                    cell.attr('data-markdown', originalContent);
                    
                    // Replace Markdown links with HTML links for display
                    let displayContent = originalContent.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                    cell.html(displayContent);
                }
            }
            
            // Add row button
            $("#add-row").click(function() {
                var columnCount = $("#editable-table thead th").length;
                var newRow = $("<tr>");
                
                for (var i = 0; i < columnCount; i++) {
                    newRow.append('<td class="editable" contenteditable="true"></td>');
                }
                
                // Insert at the top of the table instead of the bottom
                $("#editable-table tbody").prepend(newRow);
                
                // Select the new row
                $("#editable-table tbody tr").removeClass("selected");
                newRow.addClass("selected");
                
                // Focus on the first cell of the new row
                newRow.find("td:first").focus();
                
                initTableRowSorting(); // Reinitialize row sorting
            });

            // Delete row button
            $("#delete-row").click(function() {
                // Check if any row is selected
                const selectedRow = $("#editable-table tbody tr.selected");
                
                if (selectedRow.length > 0) {
                    // Delete the selected row
                    selectedRow.remove();
                } else if ($("#editable-table tbody tr").length > 1) {
                    // If no row is selected, delete the last row (fallback behavior)
                    $("#editable-table tbody tr:last").remove();
                } else {
                    alert("Cannot delete the last row!");
                    return;
                }
                
                // Update the diagram with current settings
                redrawSankeyDiagram();
            });
            
            // Clear table button
            $("#clear-table").click(function() {
                if (confirm("Are you sure you want to clear all data?")) {
                    // Clear the table
                    $("#editable-table tbody").empty();
                    
                    // Remove any warning messages
                    $(".info-panel.warning").remove();
                    
                    // Add one empty row
                    var columnCount = $("#editable-table thead th").length;
                    var newRow = $("<tr>");
                    
                    for (var i = 0; i < columnCount; i++) {
                        newRow.append('<td class="editable" contenteditable="true"></td>');
                    }
                    
                    $("#editable-table tbody").append(newRow);
                    initTableRowSorting(); // Reinitialize row sorting
                    // Update the diagram with current settings
                    redrawSankeyDiagram();
                }
            });
            
            // Load sample data button
            $("#load-sample").click(function() {
                if (confirm("This will replace your current data with sample data. Continue?")) {
                    loadSampleData();
                    initTableRowSorting(); // Reinitialize row sorting
                    // Update the diagram with current settings
                    redrawSankeyDiagram();
                }
            });
            
            // Load CSV button
            $("#load-csv-btn").click(function() {
                $("#csv-file-input").click();
            });
            
            // Handle CSV file selection
            $("#csv-file-input").change(function(e) {
                var file = e.target.files[0];
                if (file) {
                    if (confirm("This will replace your current data with the CSV data. Continue?")) {
                        parseCSVFile(file);
                        // Reset the file input so the same file can be selected again
                        $(this).val('');
                    } else {
                        // Reset the file input if user cancels
                        $(this).val('');
                    }
                }
            });
            
            // Rename column button
            $("#rename-column").click(function() {
                updateColumnSelectOptions();
                $("#rename-modal").css("display", "block");
            });
            
            // Cancel rename
            $("#cancel-rename").click(function() {
                $("#rename-modal").css("display", "none");
            });
            
            // Confirm rename
            $("#confirm-rename").click(function() {
                var columnIndex = $("#column-select").val();
                var newName = $("#new-column-name").val().trim();
                
                if (newName) {
                    var th = $("#editable-table thead th").eq(columnIndex);
                    
                    // Keep the header controls when renaming
                    const headerControls = th.find('.header-controls').clone();
                    th.html(newName);
                    th.prepend(headerControls);
                    
                    th.attr("data-name", newName);
                    
                    // Reinitialize column controls after renaming
                    initColumnControls();
                    
                    // Update the column select dropdown
                    updateColumnSelectOptions();
                    
                    // Clear the input
                    $("#new-column-name").val("");
                    
                    // Hide the modal
                    $("#rename-modal").css("display", "none");
                    
                    // Update the diagram with current settings
                    redrawSankeyDiagram();
                } else {
                    alert("Please enter a column name");
                }
            });
            
            // Initialize table row sorting
            function initTableRowSorting() {
                $("#editable-table tbody").sortable({
                    helper: function(e, tr) {
                        var $originals = tr.children();
                        var $helper = tr.clone();
                        $helper.children().each(function(index) {
                            $(this).width($originals.eq(index).width());
                        });
                        return $helper;
                    },
                    start: function(e, ui) {
                        // Mark the row as selected when starting to drag
                        $("#editable-table tbody tr").removeClass("selected");
                        ui.item.addClass("selected");
                    },
                    update: function() {
                        // Auto-update the diagram when rows are reordered
                        // Update the diagram with current settings
                        redrawSankeyDiagram();
                    }
                }).disableSelection();
                
                // Add click handler for row selection
                $("#editable-table tbody").on("click", "tr", function(e) {
                    // Only select the row if the click wasn't on an editable cell (that's handled separately)
                    if (!$(e.target).hasClass("editable")) {
                        $("#editable-table tbody tr").removeClass("selected");
                        $(this).addClass("selected");
                    }
                });
            }
            
            // Update column controls
            function updateColumnControls() {
                // Update the move buttons in the header
                $("#editable-table thead th").each(function(index) {
                    const totalColumns = $("#editable-table thead th").length;
                    
                    // Get the control buttons
                    const leftBtn = $(this).find('.move-left');
                    const rightBtn = $(this).find('.move-right');
                    
                    // Update data-index attributes and disabled state
                    leftBtn.attr('data-index', index);
                    rightBtn.attr('data-index', index);
                    
                    leftBtn.prop('disabled', index === 0);
                    rightBtn.prop('disabled', index === totalColumns - 1);
                });
            }
            
            // Initialize column control buttons
            function initColumnControls() {
                // Remove any existing handlers first
                $(".header-button").off('click');
                
                // Add event listeners for column movement buttons
                $(".header-button.move-left").on('click', function(e) {
                    e.stopPropagation(); // Prevent event bubbling
                    const index = parseInt($(this).attr("data-index"));
                    
                    if (index > 0) {
                        moveColumn(index, index - 1);
                        updateColumnControls();
                        // Update the diagram with current settings
                        redrawSankeyDiagram();
                    }
                });
                
                $(".header-button.move-right").on('click', function(e) {
                    e.stopPropagation(); // Prevent event bubbling
                    const index = parseInt($(this).attr("data-index"));
                    
                    if (index < $("#editable-table thead th").length - 1) {
                        moveColumn(index, index + 1);
                        updateColumnControls();
                        // Update the diagram with current settings
                        redrawSankeyDiagram();
                    }
                });
                
                // Update the button states
                updateColumnControls();
                
                console.log("Column controls initialized");
            }
            
            // Function to move a column in the table
            function moveColumn(fromIdx, toIdx) {
                // Move the column in each row
                $("#editable-table tr").each(function() {
                    var row = $(this);
                    var cells = row.find("th, td");
                    
                    // Get the cell we're moving
                    var cellToMove = cells.eq(fromIdx);
                    
                    // Remove it from its current position
                    cellToMove.detach();
                    
                    // Insert it at the new position
                    if (toIdx < fromIdx) {
                        // Moving left
                        cells.eq(toIdx).before(cellToMove);
                    } else {
                        // Moving right
                        cells.eq(toIdx).after(cellToMove);
                    }
                });
                
                // Update the column select dropdown
                updateColumnSelectOptions();
            }
            
            // Update column select options
            function updateColumnSelectOptions() {
                var select = $("#column-select");
                select.empty();
                
                $("#editable-table thead th").each(function(index) {
                    var name = $(this).text().trim();
                    select.append('<option value="' + index + '">' + name + '</option>');
                });
            }
            
            // Load sample data function
            function loadSampleData() {
                // Clear existing rows
                $("#editable-table tbody").empty();
                
                // Remove any warning messages
                $(".info-panel.warning").remove();
                
                // Add sample data rows
                for (let i = 0; i < sampleData.length; i++) {
                    let newRow = $("<tr>");
                    
                    for (let j = 0; j < sampleData[i].length; j++) {
                        newRow.append('<td class="editable" contenteditable="true">' + sampleData[i][j] + '</td>');
                    }
                    
                    $("#editable-table tbody").append(newRow);
                }
            }
            
            // Parse CSV file function
            function parseCSVFile(file) {
                Papa.parse(file, {
                    complete: function(results) {
                        console.log("CSV parsed, rows:", results.data.length);
                        loadCSVData(results.data);
                    },
                    header: false,
                    skipEmptyLines: true
                });
            }
            
            // Load CSV from a file on the server
            function loadCSVFromFile(filename) {
                fetch(filename)
                    .then(response => response.text())
                    .then(csvText => {
                        const results = Papa.parse(csvText, {
                            header: false,
                            skipEmptyLines: true
                        });
                        console.log("CSV loaded from file, rows:", results.data.length);
                        loadCSVData(results.data);
                    })
                    .catch(error => {
                        console.error('Error loading CSV file:', error);
                    });
            }
            
            // Load CSV data into the table
            function loadCSVData(data) {
                // Clear existing rows
                $("#editable-table tbody").empty();
                
                // Remove any existing warning messages
                $(".info-panel.warning").remove();
                
                // Always skip the first row (header)
                const startRow = 1;
                
                // Check if we have data to load
                if (!data || data.length <= startRow) {
                    console.error("No data to load or data is missing header row");
                    alert("Error: The CSV file is empty or missing a header row.");
                    return;
                }
                
                console.log(`Loading ${data.length - startRow} data rows`);
                
                // Determine the maximum number of columns in the data
                let maxColumns = 0;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].length > maxColumns) {
                        maxColumns = data[i].length;
                    }
                }
                
                // Get the current number of columns in the table
                const currentColumnCount = $("#editable-table thead th").length;
                
                // If we need more columns, add them
                if (maxColumns > currentColumnCount) {
                    console.log(`Adding ${maxColumns - currentColumnCount} new columns to accommodate data`);
                    
                    // Add new header columns
                    for (let i = currentColumnCount; i < maxColumns; i++) {
                        const columnName = `Column ${i + 1}`;
                        const newHeader = $(`
                            <th data-name="${columnName}">
                                <div class="header-controls">
                                    <button class="header-button move-left" data-index="${i}">←</button>
                                    <button class="header-button move-right" data-index="${i}">→</button>
                                </div>
                                ${columnName}
                            </th>
                        `);
                        $("#editable-table thead tr").append(newHeader);
                    }
                    
                    // Update column controls
                    updateColumnControls();
                }
                
                // Add data rows (skip header row)
                let rowsAdded = 0;
                let rowsWithWarnings = 0;
                
                for (let i = startRow; i < data.length; i++) {
                    let newRow = $("<tr>");
                    let rowData = data[i];
                    let hasWarning = false;
                    
                    // Skip completely empty rows
                    if (!rowData || rowData.every(cell => !cell || cell.trim() === "")) {
                        console.log(`Skipping empty row at index ${i}`);
                        continue;
                    }
                    
                    // Check if row has inconsistent column count
                    if (rowData.length < 5) {
                        console.warn(`Row ${i} has fewer than 5 columns: ${rowData.length}`);
                        hasWarning = true;
                    } else if (rowData.length > 5 && rowData.length <= maxColumns) {
                        console.warn(`Row ${i} has more than 5 columns: ${rowData.length}`);
                        hasWarning = true;
                    }
                    
                    // Get the current number of columns in the table (might have been updated)
                    const columnCount = $("#editable-table thead th").length;
                    
                    for (let j = 0; j < columnCount; j++) {
                        // Get cell value and trim whitespace
                        const cellValue = j < rowData.length ? rowData[j].trim() : "";
                        
                        // Create the cell
                        const cell = $('<td class="editable" contenteditable="false"></td>');
                        
                        // Add warning class if this row has inconsistent column count
                        if (hasWarning) {
                            cell.addClass("warning-cell");
                        }
                        
                        // Check if the cell value contains a Markdown link
                        if (/\[([^\]]+)\]\(([^)]+)\)/g.test(cellValue)) {
                            // Store the Markdown format in a data attribute for editing
                            cell.attr('data-markdown', cellValue);
                            
                            // Convert Markdown links to HTML links for display
                            let displayContent = cellValue.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                            cell.html(displayContent);
                        } else {
                            // If no Markdown links, just use the text
                            cell.text(cellValue);
                        }
                        
                        newRow.append(cell);
                    }
                    
                    $("#editable-table tbody").append(newRow);
                    rowsAdded++;
                    
                    if (hasWarning) {
                        rowsWithWarnings++;
                    }
                }
                
                console.log(`Added ${rowsAdded} rows to table (${rowsWithWarnings} with warnings)`);
                
                // Show warning message if there were rows with inconsistent column counts
                if (rowsWithWarnings > 0) {
                    const warningMsg = $(`
                        <div class="info-panel warning" style="margin-top: 10px;">
                            <p><strong>Warning:</strong> ${rowsWithWarnings} rows had inconsistent column counts. 
                            These rows are highlighted in the table. The Sankey diagram may not display these connections correctly.</p>
                        </div>
                    `);
                    
                    // Insert warning after the table controls
                    $(".table-controls").after(warningMsg);
                    
                    // Add CSS for warning cells
                    if (!$("style:contains('.warning-cell')").length) {
                        $("head").append(`
                            <style>
                                .warning-cell {
                                    background-color: #fff3cd !important;
                                }
                                .warning {
                                    background-color: #fff3cd;
                                    border: 1px solid #ffeeba;
                                    color: #856404;
                                    padding: 10px;
                                    border-radius: 4px;
                                    margin-bottom: 15px;
                                }
                            </style>
                        `);
                    }
                }
                
                // Reinitialize row sorting
                initTableRowSorting();
                
                // Reinitialize column controls
                initColumnControls();
                
                // Update the diagram with current settings
                redrawSankeyDiagram();
            }

            // Handle Sankey options changes
            $("#sankey-options input, #sankey-options select").on("input change", function() {
                // Update settings object
                sankeySettings.nodeWidth = parseInt($("#node-width").val());
                sankeySettings.nodePadding = parseInt($("#node-padding").val());
                sankeySettings.curvature = parseFloat($("#curvature").val());
                sankeySettings.nodeAlignment = $("#node-alignment").val();
                sankeySettings.showValues = $("#show-values").val() === "true";
                sankeySettings.diagramScale = parseInt($("#diagram-scale").val());
                sankeySettings.fontSize = parseInt($("#font-size").val());
                
                console.log("Settings updated:", sankeySettings);
                
                // Force complete redraw of the diagram
                redrawSankeyDiagram();
            });
            
            // Function to completely redraw the diagram with current settings
            function redrawSankeyDiagram() {
                // Clear the container
                $("#mermaid-container").empty();
                
                // Log current settings for debugging
                console.log("Applying settings:", JSON.stringify(sankeySettings));
                
                // Re-initialize mermaid with new settings
                mermaid.initialize({
                    startOnLoad: false,  // Changed to false to prevent auto-initialization
                    theme: 'default',
                    securityLevel: 'loose',
                    flowchart: { useMaxWidth: false },
                    sankey: { 
                        useMaxWidth: true,
                        nodeWidth: sankeySettings.nodeWidth,
                        nodePadding: sankeySettings.nodePadding,
                        curvature: sankeySettings.curvature,
                        nodeAlignment: sankeySettings.nodeAlignment,
                        showValues: sankeySettings.showValues
                    }
                });
                
                // Generate new diagram content
                generateSankeyDiagram();
            }
            
            // Generate Sankey diagram from table data
            function generateSankeyDiagram() {
                // Clear any previous error messages
                $("#mermaid-error").empty().hide();
                
                // This function adapts the logic from makeMermaid.py to JavaScript
                let sankeyData = [];
                let debugInfo = [];
                
                // Get column headers
                let headers = [];
                $("#editable-table thead th").each(function() {
                    headers.push($(this).text().trim());
                });
                
                // Process each row
                $("#editable-table tbody tr").each(function(rowIndex) {
                    let rowData = [];
                    $(this).find("td").each(function() {
                        // Get text content and pre-sanitize it
                        let cellText = $(this).text().trim();
                        // Remove apostrophes right away
                        cellText = cellText.replace(/'/g, "");
                        rowData.push(cellText);
                    });
                    
                    // Skip empty rows
                    if (rowData.every(cell => cell === "")) {
                        return;
                    }
                    
                    // Create Sankey connections from the row
                    for (let i = 0; i < rowData.length - 1; i++) {
                        let source = rowData[i];
                        let target = rowData[i + 1];
                        
                        // Skip if either source or target is empty
                        if (source && target) {
                            // Sanitize source and target for Mermaid
                            const originalSource = source;
                            const originalTarget = target;
                            
                            source = sanitizeForMermaid(source);
                            target = sanitizeForMermaid(target);
                            
                            // Add to sankeyData only if both source and target are valid after sanitization
                            if (source && target) {
                                sankeyData.push([source, target, 10]);
                                
                                // Add debug info for this connection
                                debugInfo.push({
                                    rowIndex: rowIndex,
                                    originalSource: originalSource,
                                    sanitizedSource: source,
                                    originalTarget: originalTarget,
                                    sanitizedTarget: target
                                });
                            }
                        }
                    }
                });
                
                // Generate Mermaid Sankey diagram text
                let mermaidText = "sankey-beta\n";
                
                // Add connections to the diagram with line numbers for debugging
                sankeyData.forEach((connection, index) => {
                    const lineText = `${connection[0]}, ${connection[1]}, ${connection[2]}`;
                    mermaidText += lineText + "\n";
                    
                    // Log every 10th line for debugging
                    if (index % 10 === 0 || index > 75) {
                        console.log(`Line ${index + 2}: ${lineText}`);
                    }
                });
                
                // If no data, show a placeholder
                if (sankeyData.length === 0) {
                    mermaidText += "Country, City-Town, 10\n";
                    mermaidText += "City-Town, Person, 10\n";
                    mermaidText += "Person, Project, 10\n";
                    mermaidText += "Project, Organization, 10\n";
                }
                
                // Log the sanitized data for debugging
                console.log("Sanitized Sankey Data Count:", sankeyData.length);
                console.log("Debug Info Count:", debugInfo.length);
                
                // Create a new container for the diagram
                const scale = sankeySettings.diagramScale / 100;
                const container = $('<div class="mermaid-wrapper"></div>');
                const pre = $('<pre class="mermaid"></pre>').text(mermaidText);
                container.append(pre);
                $("#mermaid-container").html('<div id="mermaid-error"></div>');
                $("#mermaid-container").append(container);
                
                // Double-check the mermaid text for any remaining apostrophes
                const finalText = pre.text();
                if (finalText.includes("'")) {
                    console.error("WARNING: Apostrophes still present in final Mermaid text!");
                    pre.text(finalText.replace(/'/g, ""));
                }
                
                // Render the diagram
                renderMermaidDiagram();
            }
            
            // Render the Mermaid diagram
            function renderMermaidDiagram() {
                try {
                    // Clear any previous error messages
                    $("#mermaid-error").empty().hide();
                    
                    // Get the Mermaid text from the pre element
                    const mermaidElement = $(".mermaid");
                    let mermaidText = mermaidElement.text();
                    
                    // Log the raw Mermaid text for debugging
                    console.log("Raw Mermaid Text (first 100 chars):", mermaidText.substring(0, 100));
                    
                    // Check for problematic apostrophes and remove them
                    if (mermaidText.includes("'")) {
                        console.error("WARNING: Apostrophes found in Mermaid text - removing them");
                        mermaidText = removeAllApostrophes(mermaidText);
                        mermaidElement.text(mermaidText);
                    }
                    
                    // Initialize Mermaid with the current settings
                    mermaid.initialize({
                        startOnLoad: false,
                        securityLevel: 'loose',
                        theme: sankeySettings.theme,
                        sankey: {
                            nodeWidth: sankeySettings.nodeWidth,
                            nodePadding: sankeySettings.nodePadding,
                            curvature: sankeySettings.curvature,
                            nodeAlignment: sankeySettings.nodeAlignment,
                            showValues: sankeySettings.showValues
                        },
                        flowchart: {
                            useMaxWidth: false
                        },
                        // Add error handling callback
                        logLevel: 'error',
                        fontFamily: 'Arial, sans-serif'
                    });
                    
                    // Try the newer API first
                    try {
                        mermaid.run({
                            querySelector: '.mermaid',
                            suppressErrors: false
                        }).catch(error => {
                            console.error("Mermaid run API error:", error);
                            // Fall back to the older API
                            fallbackRendering();
                        });
                    } catch (error) {
                        console.error("Error with mermaid.run:", error);
                        // Fall back to the older API
                        fallbackRendering();
                    }
                    
                    // Apply scaling after the diagram is rendered
                    setTimeout(() => {
                        // First, ensure the container has enough space
                        const svgElement = $(".mermaid-wrapper svg");
                        if (!svgElement.length) {
                            console.error("SVG element not properly loaded or has zero width");
                            return;
                        }
                        
                        // Apply the scale
                        const scale = sankeySettings.diagramScale / 100;
                        if (scale !== 1) {
                            svgElement.css({
                                transform: `scale(${scale})`,
                                transformOrigin: 'top left'
                            });
                        }
                        
                        // Apply font size to all text elements in the SVG
                        svgElement.find('text').css('font-size', `${sankeySettings.fontSize}px`);
                        
                    }, 1000); // Increased timeout to ensure rendering completes
                } catch (error) {
                    console.error("Error in renderMermaidDiagram:", error);
                    
                    // Show error message with details
                    const errorMessage = $("<div>")
                        .addClass("error-message")
                        .html(`<strong>Error rendering diagram:</strong> ${error.message || error}<br><br>
                               Check console for more details.`);
                    
                    $("#mermaid-error").html(errorMessage).show();
                }
                
                // Fallback rendering function using the older API
                function fallbackRendering() {
                    console.log("Using fallback rendering method");
                    try {
                        // Try the older API
                        mermaid.init(undefined, document.querySelector('.mermaid'));
                    } catch (error) {
                        console.error("Fallback rendering also failed:", error);
                        
                        // Last resort: Show simplified diagram
                        showSimplifiedDiagram();
                    }
                }
                
                // Last resort function to show a simplified diagram
                function showSimplifiedDiagram() {
                    console.log("Using simplified diagram as last resort");
                    
                    // Create a very simple diagram with minimal nodes
                    const simplifiedText = "sankey-beta\nA, B, 10\nB, C, 10\n";
                    $(".mermaid").text(simplifiedText);
                    
                    // Try one more time with the simplest possible diagram
                    try {
                        mermaid.init(undefined, document.querySelector('.mermaid'));
                    } catch (error) {
                        console.error("Even simplified diagram failed:", error);
                        
                        // Show error and raw data
                        const errorMessage = $("<div>")
                            .addClass("error-message")
                            .html(`<strong>Mermaid rendering failed:</strong> ${error.message || error}<br><br>
                                   This may be due to a compatibility issue with your browser or the Mermaid library.<br><br>
                                   You can still export your data as CSV or Mermaid file.`);
                        
                        $("#mermaid-error").html(errorMessage).show();
                    }
                }
            }
            
            // Helper function to sanitize text for Mermaid
            function sanitizeForMermaid(text) {
                if (!text) return text;
                
                // Convert to string if not already
                text = String(text);
                
                // Remove ALL types of apostrophes and quotes
                text = removeAllApostrophes(text);
                
                // Replace other problematic characters that cause Mermaid syntax errors
                // Keep capital letters and spaces intact
                let sanitized = text
                    // Replace other problematic characters
                    .replace(/;/g, "")
                    .replace(/:/g, "")
                    .replace(/\//g, "-")
                    .replace(/\\/g, "-")
                    .replace(/\(/g, "")
                    .replace(/\)/g, "")
                    .replace(/,/g, "")
                    .replace(/"/g, "")
                    .replace(/\n/g, " ")
                    .replace(/#/g, "")
                    .replace(/\+/g, "")
                    .replace(/%/g, "")
                    .replace(/\*/g, "")
                    .replace(/\^/g, "")
                    .replace(/\|/g, "-")
                    .replace(/</g, "")
                    .replace(/>/g, "")
                    .replace(/=/g, "")
                    .replace(/\[/g, "")
                    .replace(/\]/g, "")
                    .replace(/\{/g, "")
                    .replace(/\}/g, "")
                    .replace(/\$/g, "")
                    .replace(/@/g, "")
                    .replace(/!/g, "")
                    .replace(/~/g, "-")
                    .replace(/`/g, "")
                    .trim();
                
                // Double-check for apostrophes that might have been missed
                sanitized = removeAllApostrophes(sanitized);
                
                // Truncate if too long (Mermaid can have issues with very long node names)
                if (sanitized.length > 30) {
                    sanitized = sanitized.substring(0, 27) + "...";
                }
                
                // Ensure the text is not empty after sanitization
                if (!sanitized) {
                    sanitized = "node";
                }
                
                return sanitized;
            }
            
            // Helper function to remove ALL types of apostrophes and quotes
            function removeAllApostrophes(text) {
                if (!text) return text;
                
                // This handles ALL possible apostrophe and quote characters:
                // - Standard apostrophe (')
                // - Left/right single quotes ('/')
                // - Left/right double quotes ("")
                // - Prime/double prime (′/″)
                return text.replace(/[\u0027\u2018\u2019\u201A\u201B\u2032\u2035\u201C\u201D\u201E\u201F\u2033\u2036\u2018\u2019\u201C\u201D]/g, "");
            }
            
            // Export data to a Mermaid file
            $("#export-data").click(function() {
                // Get the current Mermaid diagram data
                let sankeyData = [];
                
                // Process each row to create connections
                $("#editable-table tbody tr").each(function(rowIndex) {
                    let rowData = [];
                    $(this).find("td").each(function() {
                        // Get text content
                        let cellText = $(this).text().trim();
                        rowData.push(cellText);
                    });
                    
                    // Skip empty rows
                    if (rowData.every(cell => cell === "")) {
                        return;
                    }
                    
                    // Create Sankey connections from the row
                    for (let i = 0; i < rowData.length - 1; i++) {
                        let source = rowData[i];
                        let target = rowData[i + 1];
                        
                        // Skip if either source or target is empty
                        if (source && target) {
                            // Sanitize source and target for Mermaid
                            source = sanitizeForMermaid(source);
                            target = sanitizeForMermaid(target);
                            
                            // Add to sankeyData only if both source and target are valid after sanitization
                            if (source && target) {
                                sankeyData.push([source, target, 10]);
                            }
                        }
                    }
                });
                
                // Generate Mermaid Sankey diagram text with YAML frontmatter for configuration
                let mermaidText = "---\n";
                mermaidText += "config:\n";
                mermaidText += "  sankey:\n";
                mermaidText += `    nodeWidth: ${sankeySettings.nodeWidth}\n`;
                mermaidText += `    nodePadding: ${sankeySettings.nodePadding}\n`;
                mermaidText += `    curvature: ${sankeySettings.curvature}\n`;
                mermaidText += `    nodeAlignment: ${sankeySettings.nodeAlignment}\n`;
                mermaidText += `    showValues: ${sankeySettings.showValues}\n`;
                mermaidText += `    diagramScale: ${sankeySettings.diagramScale}\n`;
                mermaidText += `    fontSize: ${sankeySettings.fontSize}\n`;
                mermaidText += "---\n\n";
                
                // Add Sankey directive
                mermaidText += "sankey-beta\n";
                
                // Add connections to the diagram
                sankeyData.forEach(connection => {
                    mermaidText += `${connection[0]}, ${connection[1]}, ${connection[2]}\n`;
                });
                
                // Create and download the file
                const blob = new Blob([mermaidText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sankey-diagram.mmd';
                a.click();
                
                URL.revokeObjectURL(url);
            });
            
            // Export table data to CSV
            $("#export-csv").click(function() {
                // Get table data
                let csvData = [];
                
                // Get header row
                let headerRow = [];
                $("#editable-table thead th").each(function() {
                    headerRow.push($(this).text().trim());
                });
                csvData.push(headerRow);
                
                // Get data rows
                $("#editable-table tbody tr").each(function() {
                    let rowData = [];
                    $(this).find("td").each(function() {
                        rowData.push($(this).text().trim());
                    });
                    
                    // Only add non-empty rows
                    if (!rowData.every(cell => cell === "")) {
                        csvData.push(rowData);
                    }
                });
                
                // Convert to CSV string using PapaParse
                const csvString = Papa.unparse(csvData);
                
                // Create and download the file
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sankey-data.csv';
                a.click();
                
                URL.revokeObjectURL(url);
            });
            
            // Save Options button
            $("#save-options").click(function() {
                // Create a JSON object with the current settings
                const optionsData = {
                    nodeWidth: sankeySettings.nodeWidth,
                    nodePadding: sankeySettings.nodePadding,
                    curvature: sankeySettings.curvature,
                    nodeAlignment: sankeySettings.nodeAlignment,
                    showValues: sankeySettings.showValues,
                    diagramScale: sankeySettings.diagramScale,
                    fontSize: sankeySettings.fontSize
                };
                
                // Convert to JSON string
                const jsonString = JSON.stringify(optionsData, null, 2);
                
                // Create and download the file
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sankey-options.json';
                a.click();
                
                URL.revokeObjectURL(url);
            });
            
            // Load Options button
            $("#load-options").click(function() {
                $("#options-file-input").click();
            });
            
            // Handle options file selection
            $("#options-file-input").change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        try {
                            // Parse the JSON data
                            const optionsData = JSON.parse(event.target.result);
                            
                            // Update the settings object
                            if (optionsData.nodeWidth !== undefined) sankeySettings.nodeWidth = optionsData.nodeWidth;
                            if (optionsData.nodePadding !== undefined) sankeySettings.nodePadding = optionsData.nodePadding;
                            if (optionsData.curvature !== undefined) sankeySettings.curvature = optionsData.curvature;
                            if (optionsData.nodeAlignment !== undefined) sankeySettings.nodeAlignment = optionsData.nodeAlignment;
                            if (optionsData.showValues !== undefined) sankeySettings.showValues = optionsData.showValues;
                            if (optionsData.diagramScale !== undefined) sankeySettings.diagramScale = optionsData.diagramScale;
                            if (optionsData.fontSize !== undefined) sankeySettings.fontSize = optionsData.fontSize;
                            
                            // Update the UI controls
                            $("#node-width").val(sankeySettings.nodeWidth);
                            $("#node-padding").val(sankeySettings.nodePadding);
                            $("#curvature").val(sankeySettings.curvature);
                            $("#node-alignment").val(sankeySettings.nodeAlignment);
                            $("#show-values").val(sankeySettings.showValues.toString());
                            $("#diagram-scale").val(sankeySettings.diagramScale);
                            $("#font-size").val(sankeySettings.fontSize);
                            
                            // Update the diagram with new settings
                            redrawSankeyDiagram();
                            
                            console.log("Options loaded successfully:", optionsData);
                        } catch (error) {
                            console.error("Error parsing options file:", error);
                            alert("Error loading options file. Please ensure it's a valid JSON file.");
                        }
                    };
                    
                    reader.readAsText(file);
                }
            });
            
            // Fit to Width button
            $("#fit-width").click(function() {
                fitDiagramToWidth();
            });
            
            // Function to fit diagram to current container width
            function fitDiagramToWidth() {
                // Get the container width
                const containerWidth = $("#mermaid-container").width();
                
                // Get the current SVG width
                const svgElement = $(".mermaid-wrapper svg");
                const svgWidth = svgElement.width();
                
                if (svgWidth === 0) {
                    console.error("SVG element not properly loaded or has zero width");
                    return;
                }
                
                // Calculate the scale needed to fit the width
                let scale = (containerWidth - 40) / svgWidth; // 40px padding for safety
                
                // Set a maximum scale limit to prevent excessive magnification
                const MAX_SCALE = 1.5; // 150% maximum scale
                if (scale > MAX_SCALE) {
                    scale = MAX_SCALE;
                    console.log("Scale limited to maximum:", MAX_SCALE);
                }
                
                // Set a minimum scale limit to prevent excessive reduction
                const MIN_SCALE = 0.3; // 30% minimum scale
                if (scale < MIN_SCALE) {
                    scale = MIN_SCALE;
                    console.log("Scale limited to minimum:", MIN_SCALE);
                }
                
                // Update the scale setting and input field
                sankeySettings.diagramScale = Math.round(scale * 100);
                $("#diagram-scale").val(sankeySettings.diagramScale);
                
                // Apply the new scale
                redrawSankeyDiagram();
                
                console.log("Fit to width applied. New scale:", sankeySettings.diagramScale + "%");
            }
            
            // Initialize the column select dropdown
            updateColumnSelectOptions();
            
            // Load CSV from URL button
            $("#load-csv-url").click(function() {
                const url = $("#csv-url-input").val().trim();
                
                if (!url) {
                    alert("Please enter a valid URL to a CSV file.");
                    return;
                }
                
                if (confirm("This will replace your current data with the CSV data from the URL. Continue?")) {
                    // Show loading indicator
                    $(this).text("Loading...").prop("disabled", true);
                    
                    // Fetch the CSV from the URL
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(csvText => {
                            console.log("CSV loaded from URL successfully");
                            
                            // Remove ALL types of apostrophes and quotes from the entire CSV text
                            csvText = removeAllApostrophes(csvText);
                            
                            // Parse the CSV text
                            const results = Papa.parse(csvText, {
                                header: false,
                                skipEmptyLines: true
                            });
                            
                            console.log("CSV parsed from URL, rows:", results.data.length);
                            
                            // Load the data into the table
                            loadCSVData(results.data);
                            
                            // Generate and render the diagram
                            generateSankeyDiagram();
                        })
                        .catch(error => {
                            console.error("Error loading CSV from URL:", error);
                            alert(`Error loading CSV from URL: ${error.message}`);
                        })
                        .finally(() => {
                            // Reset button state
                            $("#load-csv-url").text("Load from URL").prop("disabled", false);
                        });
                }
            });
            
            // Generate Sankey diagram from table data
            function generateSankeyDiagram() {
                // Clear any previous error messages
                $("#mermaid-error").empty().hide();
                
                // This function adapts the logic from makeMermaid.py to JavaScript
                let sankeyData = [];
                let debugInfo = [];
                
                // Get column headers
                let headers = [];
                $("#editable-table thead th").each(function() {
                    headers.push($(this).text().trim());
                });
                
                // Process each row
                $("#editable-table tbody tr").each(function(rowIndex) {
                    let rowData = [];
                    $(this).find("td").each(function() {
                        // Get text content and pre-sanitize it
                        let cellText = $(this).text().trim();
                        // Remove apostrophes right away
                        cellText = cellText.replace(/'/g, "");
                        rowData.push(cellText);
                    });
                    
                    // Skip empty rows
                    if (rowData.every(cell => cell === "")) {
                        return;
                    }
                    
                    // Create Sankey connections from the row
                    for (let i = 0; i < rowData.length - 1; i++) {
                        let source = rowData[i];
                        let target = rowData[i + 1];
                        
                        // Skip if either source or target is empty
                        if (source && target) {
                            // Sanitize source and target for Mermaid
                            const originalSource = source;
                            const originalTarget = target;
                            
                            source = sanitizeForMermaid(source);
                            target = sanitizeForMermaid(target);
                            
                            // Add to sankeyData only if both source and target are valid after sanitization
                            if (source && target) {
                                sankeyData.push([source, target, 10]);
                                
                                // Add debug info for this connection
                                debugInfo.push({
                                    rowIndex: rowIndex,
                                    originalSource: originalSource,
                                    sanitizedSource: source,
                                    originalTarget: originalTarget,
                                    sanitizedTarget: target
                                });
                            }
                        }
                    }
                });
                
                // Generate Mermaid Sankey diagram text
                let mermaidText = "sankey-beta\n";
                
                // Add connections to the diagram with line numbers for debugging
                sankeyData.forEach((connection, index) => {
                    const lineText = `${connection[0]}, ${connection[1]}, ${connection[2]}`;
                    mermaidText += lineText + "\n";
                    
                    // Log every 10th line for debugging
                    if (index % 10 === 0 || index > 75) {
                        console.log(`Line ${index + 2}: ${lineText}`);
                    }
                });
                
                // If no data, show a placeholder
                if (sankeyData.length === 0) {
                    mermaidText += "Country, City-Town, 10\n";
                    mermaidText += "City-Town, Person, 10\n";
                    mermaidText += "Person, Project, 10\n";
                    mermaidText += "Project, Organization, 10\n";
                }
                
                // Log the sanitized data for debugging
                console.log("Sanitized Sankey Data Count:", sankeyData.length);
                console.log("Debug Info Count:", debugInfo.length);
                
                // Create a new container for the diagram
                const scale = sankeySettings.diagramScale / 100;
                const container = $('<div class="mermaid-wrapper"></div>');
                const pre = $('<pre class="mermaid"></pre>').text(mermaidText);
                container.append(pre);
                $("#mermaid-container").html('<div id="mermaid-error"></div>');
                $("#mermaid-container").append(container);
                
                // Double-check the mermaid text for any remaining apostrophes
                const finalText = pre.text();
                if (finalText.includes("'")) {
                    console.error("WARNING: Apostrophes still present in final Mermaid text!");
                    pre.text(finalText.replace(/'/g, ""));
                }
                
                // Render the diagram
                renderMermaidDiagram();
            }
            
            // Helper function to sanitize text for Mermaid
            function sanitizeForMermaid(text) {
                if (!text) return text;
                
                // Convert to string if not already
                text = String(text);
                
                // Remove ALL types of apostrophes and quotes
                text = removeAllApostrophes(text);
                
                // Replace other problematic characters that cause Mermaid syntax errors
                // Keep capital letters and spaces intact
                let sanitized = text
                    // Replace other problematic characters
                    .replace(/;/g, "")
                    .replace(/:/g, "")
                    .replace(/\//g, "-")
                    .replace(/\\/g, "-")
                    .replace(/\(/g, "")
                    .replace(/\)/g, "")
                    .replace(/,/g, "")
                    .replace(/"/g, "")
                    .replace(/\n/g, " ")
                    .replace(/#/g, "")
                    .replace(/\+/g, "")
                    .replace(/%/g, "")
                    .replace(/\*/g, "")
                    .replace(/\^/g, "")
                    .replace(/\|/g, "-")
                    .replace(/</g, "")
                    .replace(/>/g, "")
                    .replace(/=/g, "")
                    .replace(/\[/g, "")
                    .replace(/\]/g, "")
                    .replace(/\{/g, "")
                    .replace(/\}/g, "")
                    .replace(/\$/g, "")
                    .replace(/@/g, "")
                    .replace(/!/g, "")
                    .replace(/~/g, "-")
                    .replace(/`/g, "")
                    .trim();
                
                // Double-check for apostrophes that might have been missed
                sanitized = removeAllApostrophes(sanitized);
                
                // Truncate if too long (Mermaid can have issues with very long node names)
                if (sanitized.length > 30) {
                    sanitized = sanitized.substring(0, 27) + "...";
                }
                
                // Ensure the text is not empty after sanitization
                if (!sanitized) {
                    sanitized = "node";
                }
                
                return sanitized;
            }
        });
    </script>
</body>
</html>
